/*********************************************************************
This is a port of the Adafruit SSD1306 driver to Nordic nRF52832.

Currently only I2C supported.

Original:

https://github.com/adafruit/Adafruit_SSD1306

electronut.in
*********************************************************************/

#include <stdlib.h>
#include <string.h>

#include "nrf_drv_twi.h"
#include "app_error.h"

#include "SSD1306.h"

// TWI handle
/*
// You will need something like this in your main.c:

const nrf_drv_twi_t m_twi_master = NRF_DRV_TWI_INSTANCE(0);

void twi_init (void)
{
    ret_code_t err_code;

    const nrf_drv_twi_config_t twi_sensors_config = {
       .scl                = 11,
       .sda                = 13,
       .frequency          = NRF_TWI_FREQ_100K,
       .interrupt_priority = APP_IRQ_PRIORITY_HIGH
    };

    err_code = nrf_drv_twi_init(&m_twi_master, &twi_sensors_config, NULL, NULL);        // twi in blocking mode.
    APP_ERROR_CHECK(err_code);

    nrf_drv_twi_enable(&m_twi_master);
}
*/

// the memory buffer for the LCD
#if 0
static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x80, 0x80, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0xFF,
#if (SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH > 96*16)
0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00,
0x80, 0xFF, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x8C, 0x8E, 0x84, 0x00, 0x00, 0x80, 0xF8,
0xF8, 0xF8, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80,
0x00, 0xE0, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xC7, 0x01, 0x01,
0x01, 0x01, 0x83, 0xFF, 0xFF, 0x00, 0x00, 0x7C, 0xFE, 0xC7, 0x01, 0x01, 0x01, 0x01, 0x83, 0xFF,
0xFF, 0xFF, 0x00, 0x38, 0xFE, 0xC7, 0x83, 0x01, 0x01, 0x01, 0x83, 0xC7, 0xFF, 0xFF, 0x00, 0x00,
0x01, 0xFF, 0xFF, 0x01, 0x01, 0x00, 0xFF, 0xFF, 0x07, 0x01, 0x01, 0x01, 0x00, 0x00, 0x7F, 0xFF,
0x80, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0xFF,
0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x0F, 0x3F, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xC7, 0xC7, 0x8F,
0x8F, 0x9F, 0xBF, 0xFF, 0xFF, 0xC3, 0xC0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFC, 0xFC,
0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x03, 0x03,
0x03, 0x03, 0x01, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01,
0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x03, 0x03, 0x00, 0x00,
0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x01, 0x00, 0x00, 0x00, 0x03,
0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
#if (SSD1306_LCDHEIGHT == 64)
0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x1F, 0x0F,
0x87, 0xC7, 0xF7, 0xFF, 0xFF, 0x1F, 0x1F, 0x3D, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0x7C, 0x7D, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x00, 0x30, 0x30, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xC0, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0xC0, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x3F, 0x1F,
0x0F, 0x07, 0x1F, 0x7F, 0xFF, 0xFF, 0xF8, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00,
0x00, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x0E, 0xFC, 0xF8, 0x00, 0x00, 0xF0, 0xF8, 0x1C, 0x0E,
0x06, 0x06, 0x06, 0x0C, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00, 0xFC,
0xFE, 0xFC, 0x00, 0x18, 0x3C, 0x7E, 0x66, 0xE6, 0xCE, 0x84, 0x00, 0x00, 0x06, 0xFF, 0xFF, 0x06,
0x06, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x06, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0xC0, 0xF8,
0xFC, 0x4E, 0x46, 0x46, 0x46, 0x4E, 0x7C, 0x78, 0x40, 0x18, 0x3C, 0x76, 0xE6, 0xCE, 0xCC, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x1F, 0x0F, 0x03,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00,
0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x03, 0x07, 0x0E, 0x0C,
0x18, 0x18, 0x0C, 0x06, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x01, 0x0F, 0x0E, 0x0C, 0x18, 0x0C, 0x0F,
0x07, 0x01, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00,
0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x07,
0x07, 0x0C, 0x0C, 0x18, 0x1C, 0x0C, 0x06, 0x06, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
#endif
#endif
};
#else

// static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] =
// {
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xe1,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xe0,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xc0,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0x80,0x7f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xf8,0x0,0x1f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xf0,0x0,0x1f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0x80,0x0,0xf,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xff,0x0,0x0,0x3f,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xfe,0x0,0x0,0x7,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xfe,0x0,0x0,0x1,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xfe,0x0,0x0,0x0,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
// 0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
// 0xff,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
// 0xff,0x80,0x0,0x0,0x0,0x60,0x18,0x3,0xff,0xff,0xc0,
// 0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x3f,0xff,0xc0,
// 0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x7,0xff,0xc0,
// 0xff,0xe0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0xff,0xc0,
// 0xff,0xf0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0x1f,0xc0,
// 0xff,0xf0,0x0,0x0,0x1,0xe0,0x0,0x0,0x0,0xf,0xc0,
// 0xff,0xf8,0x0,0xf,0x0,0xe0,0x0,0x0,0x0,0xf,0xc0,
// 0xff,0xfc,0x0,0x7,0xc0,0xc0,0x0,0x0,0x0,0xf,0xc0,
// 0xff,0xfe,0x0,0x7,0xf0,0x80,0x0,0x0,0x0,0xf,0xc0,
// 0xff,0xfe,0x0,0x1,0xf0,0x1,0xf0,0x0,0x0,0x1f,0xc0,
// 0xff,0xff,0x0,0x0,0xf8,0x7,0xf8,0x0,0x0,0x3f,0xc0,
// 0xff,0xff,0x80,0x0,0x0,0xf,0xf0,0x0,0x0,0xff,0xc0,
// 0xff,0xff,0xe0,0x0,0x0,0xf,0xc0,0x0,0x1,0xff,0xc0,
// 0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xc0,
// 0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xc0,
// 0xff,0xff,0xff,0x0,0x1c,0x0,0x0,0x0,0x1f,0xff,0xc0,
// 0xff,0xff,0xfc,0x0,0x3c,0x70,0x0,0x0,0x7f,0xff,0xc0,
// 0xff,0xff,0xf8,0x0,0xf8,0x70,0x0,0x0,0xff,0xff,0xc0,
// 0xff,0xff,0xf0,0x0,0xf0,0x78,0x0,0x3,0xff,0xff,0xc0,
// 0xff,0xff,0xe0,0x1,0xe0,0x3c,0x2,0x1f,0xff,0xff,0xc0,
// 0xff,0xff,0xe0,0x1,0xc0,0x3c,0x1,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xc0,0x1,0x80,0x1c,0x0,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xc0,0x0,0x0,0x1c,0x0,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0x80,0x0,0x0,0xc,0x0,0x7f,0xff,0xff,0xc0,
// 0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x7f,0xff,0xff,0xc0,
// 0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfe,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfe,0x0,0x0,0xc,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfe,0x0,0x0,0x1e,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfc,0x0,0x0,0x3e,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfc,0x0,0x0,0x7f,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfc,0x0,0x1,0xff,0x0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xf8,0x0,0xf,0xff,0x80,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xf8,0x0,0x7f,0xff,0xc0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xf8,0x3,0xff,0xff,0xe0,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xfc,0x1f,0xff,0xff,0xf8,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x3f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x7f,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
// 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0
// };

#endif

#define ssd1306_swap(a, b) { int16_t t = a; a = b; b = t; }

static int width() {return SSD1306_LCDWIDTH;}
static int height() {return SSD1306_LCDHEIGHT;}
static int getRotation() {return 0;}
int WIDTH = SSD1306_LCDWIDTH;
int HEIGHT = SSD1306_LCDHEIGHT;

// the most basic function, set a single pixel
void SSD1306_drawPixel(uint8_t *buffer, int16_t x, int16_t y, uint16_t color) {
  if ((x < 0) || (x >= width()) || (y < 0) || (y >= height()))
    return;

  // check rotation, move pixel around if necessary
  switch (getRotation()) {
  case 1:
    ssd1306_swap(x, y);
    x = WIDTH - x - 1;
    break;
  case 2:
    x = WIDTH - x - 1;
    y = HEIGHT - y - 1;
    break;
  case 3:
    ssd1306_swap(x, y);
    y = HEIGHT - y - 1;
    break;
  }

  // x is which column
    int index = x+ (y/8)*SSD1306_LCDWIDTH;
    //printf("index = %d\n", index);

    switch (color)
    {
      case WHITE:   buffer[index] |=  (1 << (y&7)); break;
      case BLACK:   buffer[index] &= ~(1 << (y&7)); break;
      case INVERSE: buffer[index] ^=  (1 << (y&7)); break;
    }

}


void SSD1306_begin(nrf_drv_twi_t const m_twi_master, uint8_t i2caddr, uint8_t vccstate, bool reset) {
  _vccstate = vccstate;
  _i2caddr = i2caddr;

  // Init sequence
  SSD1306_command(m_twi_master, i2caddr, SSD1306_DISPLAYOFF);                    // 0xAE
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETDISPLAYCLOCKDIV);            // 0xD5
  SSD1306_command(m_twi_master, i2caddr, 0x80);                                  // the suggested ratio 0x80

  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETMULTIPLEX);                  // 0xA8
  SSD1306_command(m_twi_master, i2caddr, SSD1306_LCDHEIGHT - 1);

  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETDISPLAYOFFSET);              // 0xD3
  SSD1306_command(m_twi_master, i2caddr, 0x0);                                   // no offset
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETSTARTLINE | 0x0);            // line #0
  SSD1306_command(m_twi_master, i2caddr, SSD1306_CHARGEPUMP);                    // 0x8D
  if (vccstate == SSD1306_EXTERNALVCC)
    { SSD1306_command(m_twi_master, i2caddr, 0x10); }
  else
    { SSD1306_command(m_twi_master, i2caddr, 0x14); }
  SSD1306_command(m_twi_master, i2caddr, SSD1306_MEMORYMODE);                    // 0x20
  SSD1306_command(m_twi_master, i2caddr, 0x00);                                  // 0x0 act like ks0108
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SEGREMAP | 0x1);
  SSD1306_command(m_twi_master, i2caddr, SSD1306_COMSCANDEC);

 #if defined SSD1306_128_32
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCOMPINS);                    // 0xDA
  SSD1306_command(m_twi_master, i2caddr, 0x02);
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCONTRAST);                   // 0x81
  SSD1306_command(m_twi_master, i2caddr, 0x8F);

#elif defined SSD1306_128_64
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCOMPINS);                    // 0xDA
  SSD1306_command(m_twi_master, i2caddr, 0x12);
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCONTRAST);                   // 0x81
  if (vccstate == SSD1306_EXTERNALVCC)
    { SSD1306_command(m_twi_master, i2caddr, 0x9F); }
  else
    { SSD1306_command(m_twi_master, i2caddr, 0xCF); }

#elif defined SSD1306_96_16
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCOMPINS);                    // 0xDA
  SSD1306_command(m_twi_master, i2caddr, 0x2);   //ada x12
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETCONTRAST);                   // 0x81
  if (vccstate == SSD1306_EXTERNALVCC)
    { SSD1306_command(m_twi_master, i2caddr, 0x10); }
  else
    { SSD1306_command(m_twi_master, i2caddr, 0xAF); }

#endif

  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETPRECHARGE);                  // 0xd9
  if (vccstate == SSD1306_EXTERNALVCC)
    { SSD1306_command(m_twi_master, i2caddr, 0x22); }
  else
    { SSD1306_command(m_twi_master, i2caddr, 0xF1); }
  SSD1306_command(m_twi_master, i2caddr, SSD1306_SETVCOMDETECT);                 // 0xDB
  SSD1306_command(m_twi_master, i2caddr, 0x40);
  SSD1306_command(m_twi_master, i2caddr, SSD1306_DISPLAYALLON_RESUME);           // 0xA4
  SSD1306_command(m_twi_master, i2caddr, SSD1306_NORMALDISPLAY);                 // 0xA6

  SSD1306_command(m_twi_master, i2caddr, SSD1306_DEACTIVATE_SCROLL);

  SSD1306_command(m_twi_master, i2caddr, SSD1306_DISPLAYON);//--turn on oled panel
}


void SSD1306_command(nrf_drv_twi_t const m_twi_master, uint8_t i2caddr, uint8_t c)
{
  ret_code_t ret;
  uint8_t data[] = {0x00, c};
  ret = nrf_drv_twi_tx(&m_twi_master, _i2caddr, data, 2, false);
  APP_ERROR_CHECK(ret);
}



void SSD1306_display(nrf_drv_twi_t const m_twi_master, uint8_t i2caddr, uint8_t *buffer) {
  SSD1306_command(m_twi_master, i2caddr, SSD1306_COLUMNADDR);
  SSD1306_command(m_twi_master, i2caddr, 0);   // Column start address (0 = reset)
  SSD1306_command(m_twi_master, i2caddr, SSD1306_LCDWIDTH-1); // Column end address (127 = reset)

  SSD1306_command(m_twi_master, i2caddr, SSD1306_PAGEADDR);
  SSD1306_command(m_twi_master, i2caddr, 0); // Page start address (0 = reset)
  #if SSD1306_LCDHEIGHT == 64
    SSD1306_command(m_twi_master, i2caddr, 7); // Page end address
  #endif
  #if SSD1306_LCDHEIGHT == 32
    SSD1306_command(m_twi_master, i2caddr, 3); // Page end address
  #endif
  #if SSD1306_LCDHEIGHT == 16
    SSD1306_command(m_twi_master, i2caddr, 1); // Page end address
  #endif


    // save I2C bitrate
#ifdef TWBR
    uint8_t twbrbackup = TWBR;
    TWBR = 12; // upgrade to 400KHz!
#endif

    //Serial.println(TWBR, DEC);
    //Serial.println(TWSR & 0x3, DEC);

    // I2C
    for (uint16_t i=0; i<(SSD1306_LCDWIDTH*SSD1306_LCDHEIGHT/8); i++) {
      uint8_t tmpBuf[17];
      // SSD1306_SETSTARTLINE
      tmpBuf[0] = 0x40;
      // data
      for (uint8_t j = 0; j < 16; j++) {
        tmpBuf[j+1] = buffer[i];
        i++;
      }
      i--;

      ret_code_t ret;
      ret = nrf_drv_twi_tx(&m_twi_master, _i2caddr, tmpBuf, sizeof(tmpBuf), false);
      APP_ERROR_CHECK(ret);
    }

#ifdef TWBR
    TWBR = twbrbackup;
#endif

}

// clear everything
void SSD1306_clearDisplay(uint8_t *buffer) {
  memset(buffer, 0, (SSD1306_LCDWIDTH*SSD1306_LCDHEIGHT/8));
}

