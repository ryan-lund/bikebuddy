/**
 * Copyright (c) 2014 - 2018, Nordic Semiconductor ASA
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form, except as embedded into a Nordic
 *    Semiconductor ASA integrated circuit in a product or a software update for
 *    such product, must reproduce the above copyright notice, this list of
 *    conditions and the following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. Neither the name of Nordic Semiconductor ASA nor the names of its
 *    contributors may be used to endorse or promote products derived from this
 *    software without specific prior written permission.
 *
 * 4. This software, with or without modification, must only be used with a
 *    Nordic Semiconductor ASA integrated circuit.
 *
 * 5. Any software provided in binary form under this license must not be reverse
 *    engineered, decompiled, modified and/or disassembled.
 *
 * THIS SOFTWARE IS PROVIDED BY NORDIC SEMICONDUCTOR ASA "AS IS" AND ANY EXPRESS
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY, NONINFRINGEMENT, AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL NORDIC SEMICONDUCTOR ASA OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
/** @file
 *
 * @defgroup ble_sdk_uart_over_ble_main main.c
 * @{
 * @ingroup  ble_sdk_app_nus_eval
 * @brief    UART over BLE application main file.
 *
 * This file contains the source code for a sample application that uses the Nordic UART service.
 * This application uses the @ref srvlib_conn_params module.
 */


#include <stdint.h>
#include <string.h>
#include "nordic_common.h"
#include "nrf.h"
#include "ble_hci.h"
#include "ble_advdata.h"
#include "ble_advertising.h"
#include "ble_conn_params.h"
#include "nrf_sdh.h"
#include "nrf_sdh_soc.h"
#include "nrf_sdh_ble.h"
#include "nrf_ble_gatt.h"
#include "nrf_ble_qwr.h"
#include "app_timer.h"
#include "ble_nus.h"
#include "app_uart.h"
#include "app_util_platform.h"
#include "bsp_btn_ble.h"
#include "nrf_pwr_mgmt.h"

// #include "binary.h"
// #include "ssd1306.h"
// #include "nrf_drv_twi.h"

#include "SSD1306.h"
#include "Adafruit_GFX.h"
// TWI
#include "nrf_drv_twi.h"
#include "nrf_delay.h"


#if defined (UART_PRESENT)
#include "nrf_uart.h"
#endif
#if defined (UARTE_PRESENT)
#include "nrf_uarte.h"
#endif

#include "nrf_log.h"
#include "nrf_log_ctrl.h"
#include "nrf_log_default_backends.h"

#define APP_BLE_CONN_CFG_TAG            1                                           /**< A tag identifying the SoftDevice BLE configuration. */

#define DEVICE_NAME                     "Adafruit1306"                               /**< Name of device. Will be included in the advertising data. */
#define NUS_SERVICE_UUID_TYPE           BLE_UUID_TYPE_VENDOR_BEGIN                  /**< UUID type for the Nordic UART Service (vendor specific). */

#define APP_BLE_OBSERVER_PRIO           3                                           /**< Application's BLE observer priority. You shouldn't need to modify this value. */

#define APP_ADV_INTERVAL                64                                          /**< The advertising interval (in units of 0.625 ms. This value corresponds to 40 ms). */

#define APP_ADV_DURATION                18000                                       /**< The advertising duration (180 seconds) in units of 10 milliseconds. */

#define MIN_CONN_INTERVAL               MSEC_TO_UNITS(20, UNIT_1_25_MS)             /**< Minimum acceptable connection interval (20 ms), Connection interval uses 1.25 ms units. */
#define MAX_CONN_INTERVAL               MSEC_TO_UNITS(75, UNIT_1_25_MS)             /**< Maximum acceptable connection interval (75 ms), Connection interval uses 1.25 ms units. */
#define SLAVE_LATENCY                   0                                           /**< Slave latency. */
#define CONN_SUP_TIMEOUT                MSEC_TO_UNITS(4000, UNIT_10_MS)             /**< Connection supervisory timeout (4 seconds), Supervision Timeout uses 10 ms units. */
#define FIRST_CONN_PARAMS_UPDATE_DELAY  APP_TIMER_TICKS(5000)                       /**< Time from initiating event (connect or start of notification) to first time sd_ble_gap_conn_param_update is called (5 seconds). */
#define NEXT_CONN_PARAMS_UPDATE_DELAY   APP_TIMER_TICKS(30000)                      /**< Time between each call to sd_ble_gap_conn_param_update after the first call (30 seconds). */
#define MAX_CONN_PARAMS_UPDATE_COUNT    3                                           /**< Number of attempts before giving up the connection parameter negotiation. */

#define DEAD_BEEF                       0xDEADBEEF                                  /**< Value used as error code on stack dump, can be used to identify stack location on stack unwind. */

#define UART_TX_BUF_SIZE                256                                         /**< UART TX buffer size. */
#define UART_RX_BUF_SIZE                256                                         /**< UART RX buffer size. */

#define DELAY_MS 1000

BLE_NUS_DEF(m_nus, NRF_SDH_BLE_TOTAL_LINK_COUNT);                                   /**< BLE NUS service instance. */
NRF_BLE_GATT_DEF(m_gatt);                                                           /**< GATT module instance. */
NRF_BLE_QWR_DEF(m_qwr);                                                             /**< Context for the Queued Write module.*/
BLE_ADVERTISING_DEF(m_advertising);                                                 /**< Advertising module instance. */
#define SSD1306_128_64

#ifdef SSD1306_128_64
#define SSD1306_CONFIG_VDD_PIN 04
#define SSD1306_CONFIG_SCL_PIN_0 05
#define SSD1306_CONFIG_SDA_PIN_0 28
#define SSD1306_CONFIG_SCL_PIN_1 29
#define SSD1306_CONFIG_SDA_PIN_1 30
#endif

#ifdef SSD1306_128_32
#define SSD1306_CONFIG_VDD_PIN 2
#define SSD1306_CONFIG_SCL_PIN 27
#define SSD1306_CONFIG_SDA_PIN 26
#endif

static uint8_t buffer0[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] =
{
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xe1,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xe0,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xc0,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x80,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xf8,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xf0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xff,0x0,0x0,0x3f,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x7,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x1,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x0,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0x80,0x0,0x0,0x0,0x60,0x18,0x3,0xff,0xff,0xc0,
0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x3f,0xff,0xc0,
0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x7,0xff,0xc0,
0xff,0xe0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0xff,0xc0,
0xff,0xf0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0x1f,0xc0,
0xff,0xf0,0x0,0x0,0x1,0xe0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xf8,0x0,0xf,0x0,0xe0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfc,0x0,0x7,0xc0,0xc0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfe,0x0,0x7,0xf0,0x80,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfe,0x0,0x1,0xf0,0x1,0xf0,0x0,0x0,0x1f,0xc0,
0xff,0xff,0x0,0x0,0xf8,0x7,0xf8,0x0,0x0,0x3f,0xc0,
0xff,0xff,0x80,0x0,0x0,0xf,0xf0,0x0,0x0,0xff,0xc0,
0xff,0xff,0xe0,0x0,0x0,0xf,0xc0,0x0,0x1,0xff,0xc0,
0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xc0,
0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xc0,
0xff,0xff,0xff,0x0,0x1c,0x0,0x0,0x0,0x1f,0xff,0xc0,
0xff,0xff,0xfc,0x0,0x3c,0x70,0x0,0x0,0x7f,0xff,0xc0,
0xff,0xff,0xf8,0x0,0xf8,0x70,0x0,0x0,0xff,0xff,0xc0,
0xff,0xff,0xf0,0x0,0xf0,0x78,0x0,0x3,0xff,0xff,0xc0,
0xff,0xff,0xe0,0x1,0xe0,0x3c,0x2,0x1f,0xff,0xff,0xc0,
0xff,0xff,0xe0,0x1,0xc0,0x3c,0x1,0xff,0xff,0xff,0xc0,
0xff,0xff,0xc0,0x1,0x80,0x1c,0x0,0xff,0xff,0xff,0xc0,
0xff,0xff,0xc0,0x0,0x0,0x1c,0x0,0xff,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0xc,0x0,0x7f,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x7f,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0xc,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0x1e,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x0,0x3e,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x0,0x7f,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x1,0xff,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x0,0xf,0xff,0x80,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x0,0x7f,0xff,0xc0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x3,0xff,0xff,0xe0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x1f,0xff,0xff,0xf8,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x7f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0
};

static uint8_t buffer1[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] =
{
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xe1,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xe0,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xc0,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x80,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0x0,0x7f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xf8,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xf0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xe0,0x0,0x1f,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xc0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xff,0x0,0x0,0x3f,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x7,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x1,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x0,0x80,0x0,0x7,0xff,0xff,0xff,0xc0,
0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xc0,
0xff,0x80,0x0,0x0,0x0,0x60,0x18,0x3,0xff,0xff,0xc0,
0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x3f,0xff,0xc0,
0xff,0xc0,0x0,0x0,0x0,0xe0,0x0,0x0,0x7,0xff,0xc0,
0xff,0xe0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0xff,0xc0,
0xff,0xf0,0x0,0x0,0x0,0xe0,0x0,0x0,0x0,0x1f,0xc0,
0xff,0xf0,0x0,0x0,0x1,0xe0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xf8,0x0,0xf,0x0,0xe0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfc,0x0,0x7,0xc0,0xc0,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfe,0x0,0x7,0xf0,0x80,0x0,0x0,0x0,0xf,0xc0,
0xff,0xfe,0x0,0x1,0xf0,0x1,0xf0,0x0,0x0,0x1f,0xc0,
0xff,0xff,0x0,0x0,0xf8,0x7,0xf8,0x0,0x0,0x3f,0xc0,
0xff,0xff,0x80,0x0,0x0,0xf,0xf0,0x0,0x0,0xff,0xc0,
0xff,0xff,0xe0,0x0,0x0,0xf,0xc0,0x0,0x1,0xff,0xc0,
0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xc0,
0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xc0,
0xff,0xff,0xff,0x0,0x1c,0x0,0x0,0x0,0x1f,0xff,0xc0,
0xff,0xff,0xfc,0x0,0x3c,0x70,0x0,0x0,0x7f,0xff,0xc0,
0xff,0xff,0xf8,0x0,0xf8,0x70,0x0,0x0,0xff,0xff,0xc0,
0xff,0xff,0xf0,0x0,0xf0,0x78,0x0,0x3,0xff,0xff,0xc0,
0xff,0xff,0xe0,0x1,0xe0,0x3c,0x2,0x1f,0xff,0xff,0xc0,
0xff,0xff,0xe0,0x1,0xc0,0x3c,0x1,0xff,0xff,0xff,0xc0,
0xff,0xff,0xc0,0x1,0x80,0x1c,0x0,0xff,0xff,0xff,0xc0,
0xff,0xff,0xc0,0x0,0x0,0x1c,0x0,0xff,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0xc,0x0,0x7f,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x7f,0xff,0xff,0xc0,
0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0x4,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0xc,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfe,0x0,0x0,0x1e,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x0,0x3e,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x0,0x7f,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x0,0x1,0xff,0x0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x0,0xf,0xff,0x80,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x0,0x7f,0xff,0xc0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xf8,0x3,0xff,0xff,0xe0,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xfc,0x1f,0xff,0xff,0xf8,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xfc,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xfe,0x0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x3f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x7f,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0
};



const nrf_drv_twi_t m_twi_master0 = NRF_DRV_TWI_INSTANCE(0);
const nrf_drv_twi_t m_twi_master1 = NRF_DRV_TWI_INSTANCE(1);
/**
 * @brief TWI initialization.
 */
void twi_init0 (void)
{
        ret_code_t err_code;

        const nrf_drv_twi_config_t twi_sensors_config = {
                .scl                = SSD1306_CONFIG_SCL_PIN_0,
                .sda                = SSD1306_CONFIG_SDA_PIN_0,
                .frequency          = NRF_TWI_FREQ_400K,
                .interrupt_priority = APP_IRQ_PRIORITY_LOWEST
        };

        //err_code = nrf_drv_twi_init(&m_twi_lis2dh12, &twi_lis2dh12_config, twi_handler, NULL);
        err_code = nrf_drv_twi_init(&m_twi_master0, &twi_sensors_config, NULL, NULL);    // twi in blocking mode.
        APP_ERROR_CHECK(err_code);

        nrf_drv_twi_enable(&m_twi_master0);
}

void twi_init1 (void)
{
        ret_code_t err_code;

        const nrf_drv_twi_config_t twi_sensors_config = {
                .scl                = SSD1306_CONFIG_SCL_PIN_1,
                .sda                = SSD1306_CONFIG_SDA_PIN_1,
                .frequency          = NRF_TWI_FREQ_400K,
                .interrupt_priority = APP_IRQ_PRIORITY_LOWEST
        };

        //err_code = nrf_drv_twi_init(&m_twi_lis2dh12, &twi_lis2dh12_config, twi_handler, NULL);
        err_code = nrf_drv_twi_init(&m_twi_master1, &twi_sensors_config, NULL, NULL);    // twi in blocking mode.
        APP_ERROR_CHECK(err_code);

        nrf_drv_twi_enable(&m_twi_master1);
}

void testdrawcircle(nrf_drv_twi_t const m_twi_master, uint8_t i2c_addr, uint8_t *buffer) {
    Adafruit_GFX_init(SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT, SSD1306_drawPixel, buffer);
    Adafruit_GFX_setRotation(0);
    for (int16_t i=0; i< Adafruit_GFX_height()/2; i+=2)
    {
            Adafruit_GFX_drawCircle(Adafruit_GFX_width()/2, Adafruit_GFX_height()/2, i, WHITE);
            SSD1306_display(m_twi_master, SSD1306_I2C_ADDRESS, buffer);
            nrf_delay_ms(200);
    }
}

void testdrawText(nrf_drv_twi_t const m_twi_master, uint8_t i2c_addr, uint8_t *buffer)
{
    Adafruit_GFX_init(SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT, SSD1306_drawPixel, buffer);
    Adafruit_GFX_setCursor(0,0);
    Adafruit_GFX_setTextSize(1);
    Adafruit_GFX_setTextColor(WHITE, WHITE);
    Adafruit_GFX_setRotation(2);
    Adafruit_GFX_write('H');
    Adafruit_GFX_write('e');
    Adafruit_GFX_write('l');
    Adafruit_GFX_write('l');
    Adafruit_GFX_write('o');
    SSD1306_display(m_twi_master, SSD1306_I2C_ADDRESS, buffer);

}


/**@brief Application main function.
 */
int main(void)
{       nrf_gpio_cfg_output(7);


        // Start execution.

        nrf_gpio_cfg_output(SSD1306_CONFIG_VDD_PIN);

        nrf_gpio_cfg(
                SSD1306_CONFIG_VDD_PIN,
                NRF_GPIO_PIN_DIR_OUTPUT,
                NRF_GPIO_PIN_INPUT_DISCONNECT,
                NRF_GPIO_PIN_NOPULL,
                NRF_GPIO_PIN_H0S1,
                NRF_GPIO_PIN_NOSENSE);

        nrf_gpio_pin_set(SSD1306_CONFIG_VDD_PIN);

        nrf_delay_ms(1000);


        twi_init0();
        twi_init1();

        SSD1306_begin(m_twi_master0, SSD1306_I2C_ADDRESS, SSD1306_SWITCHCAPVCC, false);
        nrf_gpio_pin_clear(7);
        nrf_gpio_pin_toggle(7);
        nrf_delay_ms(3000);
        SSD1306_begin(m_twi_master1, SSD1306_I2C_ADDRESS, SSD1306_SWITCHCAPVCC, false);
        Adafruit_GFX_init(SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT, SSD1306_drawPixel, buffer0);

        SSD1306_clearDisplay(buffer0);
        Adafruit_GFX_drawBitmap(0, 0,  el_logo, 128, 64, 1);
        SSD1306_display(m_twi_master0, SSD1306_I2C_ADDRESS, buffer0);
        nrf_delay_ms(1000);


        // Enter main loop.
        for (;;)
        {

                SSD1306_clearDisplay(buffer0);
                SSD1306_display(m_twi_master0, SSD1306_I2C_ADDRESS, buffer0);

                testdrawcircle(m_twi_master0, SSD1306_I2C_ADDRESS, buffer0);
                nrf_delay_ms(1000);
                testdrawText(m_twi_master0, SSD1306_I2C_ADDRESS, buffer0);
                nrf_delay_ms(1000);

                SSD1306_clearDisplay(buffer0);
                Adafruit_GFX_drawBitmap(0, 0,  el_logo, 128, 64, 1);
                SSD1306_display(m_twi_master0, SSD1306_I2C_ADDRESS, buffer0);
                nrf_delay_ms(1000);
                SSD1306_clearDisplay(buffer1);

                Adafruit_GFX_init(SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT, SSD1306_drawPixel, buffer1);
                SSD1306_clearDisplay(buffer1);
                SSD1306_display(m_twi_master1, SSD1306_I2C_ADDRESS, buffer1);

                testdrawcircle(m_twi_master1, SSD1306_I2C_ADDRESS, buffer1);
                nrf_delay_ms(1000);
                testdrawText(m_twi_master1, SSD1306_I2C_ADDRESS, buffer1);
                nrf_delay_ms(1000);

                SSD1306_clearDisplay(buffer1);
                Adafruit_GFX_drawBitmap(0, 0,  apple_logo, 128, 64, 1);
                SSD1306_display(m_twi_master1, SSD1306_I2C_ADDRESS, buffer1);
                nrf_delay_ms(1000);

                while (true) {
                    nrf_gpio_pin_toggle(7);
                    nrf_delay_ms(500);
                }
        }
}


/**
 * @}
 */
